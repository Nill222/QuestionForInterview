## –ß—Ç–æ —Ç–∞–∫–æ–µ ORM –∏ —á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç JDBC

**ORM (Object-Relational Mapping)** ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –æ–±—ä–µ–∫—Ç—ã.  
Hibernate ‚Äî —ç—Ç–æ —Å–∞–º–∞—è –ø–æ–ø—É–ª—è—Ä–Ω–∞—è ORM –≤ –º–∏—Ä–µ Java.

- **JDBC (Java Database Connectivity)**  
    –¢—ã –ø–∏—à–µ—à—å SQL –≤—Ä—É—á–Ω—É—é, —Å–∞–º –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å `Connection`, —Å–æ–∑–¥–∞—ë—à—å `PreparedStatement`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å `ResultSet`, —Å–ª–µ–¥–∏—à—å –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏. –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–æ –º–Ω–æ–≥–æ ¬´—Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã¬ª –∏ –ª–µ–≥–∫–æ –¥–æ–ø—É—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É.
    
- **Hibernate (ORM)**  
    –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ (`User`, `Order`, `Product`), –∞ Hibernate —Å–∞–º –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –≤ SQL –∏ –æ–±—Ä–∞—Ç–Ω–æ.  
    –ù–∞–ø—Ä–∏–º–µ—Ä:
    
    `User user = session.get(User.class, 1L);`
    
    Hibernate —Å–∞–º –≤—ã–ø–æ–ª–Ω–∏—Ç SQL –≤–∏–¥–∞:
    
    `SELECT * FROM users WHERE id = 1;`
    

**–ì–ª–∞–≤–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ**: ORM —Å–∫—Ä—ã–≤–∞–µ—Ç SQL –∑–∞ –æ–±—ä–µ–∫—Ç–∞–º–∏. –ù–æ Hibernate –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ JDBC ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∑–∞ —Ç–µ–±—è.

---

## üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏

1. **`@Entity`**  
    –ü–æ–º–µ—á–∞–µ—Ç –∫–ª–∞—Å—Å –∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é Hibernate –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î.
    
    `@Entity public class User { ... }`
    
2. **`@Id`**  
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á. –ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
    
    `@Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id;`
    
3. **`@OneToMany` / `@ManyToOne` / `@ManyToMany` / `@OneToOne`**  
    –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π. –ù–∞–ø—Ä–∏–º–µ—Ä:
    
    `@OneToMany(mappedBy = "user", fetch = FetchType.LAZY) private List<Order> orders;`
    
    –¢—É—Ç `User` –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–≥–æ `Order`.
    

---

## üîπ –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `LAZY` –∏ `EAGER`

- **`LAZY` (–ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)** ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –Ω–∏–º.
    
    `user.getOrders(); // —Ç–æ–ª—å–∫–æ —Ç—É—Ç Hibernate —Å–¥–µ–ª–∞–µ—Ç SELECT`
    
- **`EAGER` (–∂–∞–¥–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)** ‚Äî –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –≤–º–µ—Å—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é.
    
    `SELECT * FROM users u  LEFT JOIN orders o ON u.id = o.user_id`
    

‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: `EAGER` —á–∞—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ ¬´–ª–∏—à–Ω–∏–º JOIN-–∞–º¬ª –∏ –ø–∞–¥–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ü–æ—ç—Ç–æ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (`@OneToMany`, `@ManyToMany`) –≤—Å–µ–≥–¥–∞ **LAZY**, –∞ –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Å–≤—è–∑–∏ (`@ManyToOne`, `@OneToOne`) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **EAGER** (—á—Ç–æ —á–∞—Å—Ç–æ –Ω–∞–¥–æ –º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é!).

---

## üîπ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Å—Å–∏—è –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

- **–°–µ—Å—Å–∏—è (`Session`)**  
    –≠—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –≤–æ–∫—Ä—É–≥ JDBC `Connection`.  
    –í–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏ Hibernate —Ö—Ä–∞–Ω–∏—Ç **–∫—ç—à –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è** ‚Äî –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.  
    –ï—Å–ª–∏ —Ç—ã –≤—ã–∑–≤–∞–ª `session.get(User.class, 1L)` –¥–≤–∞–∂–¥—ã, Hibernate —Å–¥–µ–ª–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å**: –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –æ–Ω –¥–æ—Å—Ç–∞–Ω–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ –∫—ç—à–∞.
    
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (`Transaction`)**  
    Hibernate —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π JDBC.
    
    `Session session = sessionFactory.openSession(); 
    Transaction tx = session.beginTransaction();  
    User user = new User("Vasya"); 
    session.save(user);  
    tx.commit(); // —Ç—É—Ç Hibernate –≤—ã–∑—ã–≤–∞–µ—Ç JDBC commit() session.close();`
    
- –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ¬´–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º¬ª:
    
    1. Hibernate –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç JDBC-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (`setAutoCommit(false)`).
        
    2. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`save`, `update`, `delete`) —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ **Persistence Context** (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏).
        
    3. –ü—Ä–∏ `commit()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **flush** ‚Üí Hibernate –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —á–µ—Ä–µ–∑ JDBC.
        
    4. –ü–æ—Ç–æ–º —É–∂–µ –¥–µ–ª–∞–µ—Ç—Å—è `commit` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ JDBC.
        

---

‚úÖ –ò—Ç–æ–≥–æ:

- ORM = —Ä–∞–±–æ—Ç–∞ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤–º–µ—Å—Ç–æ SQL.
    
- –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –æ–ø–∏—Å—ã–≤–∞—é—Ç —Å—É—â–Ω–æ—Å—Ç—å –∏ –µ—ë —Å–≤—è–∑–∏.
    
- LAZY –ª—É—á—à–µ, —á–µ–º EAGER, –Ω–æ –Ω–∞–¥–æ —É–º–µ—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å `LazyInitializationException`.
    
- –°–µ—Å—Å–∏—è = –∫—ç—à + —Å–≤—è–∑—å —Å JDBC.
    
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ Hibernate = –ø—Ä–æ—Å—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ JDBC-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π.
## 1. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: —á—Ç–æ —Ç–∞–∫–æ–µ LAZY –∑–∞–≥—Ä—É–∑–∫–∞

–ö–æ–≥–¥–∞ –º—ã –ø–æ–º–µ—á–∞–µ–º —Å–≤—è–∑—å, –Ω–∞–ø—Ä–∏–º–µ—Ä:

`@OneToMany(mappedBy = "user", fetch = FetchType.LAZY) private List<Order> orders;`

Hibernate **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç** `orders` —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ `User`.  
–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω —Å–æ–∑–¥–∞—ë—Ç **–ø—Ä–æ–∫—Å–∏-–æ–±—ä–µ–∫—Ç** (–∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—é-–ø—Ä–æ–∫—Å–∏) –∏ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ë–î –¥–æ –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è.

---

## ‚öôÔ∏è 2. –ö–∞–∫ Hibernate –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–∫—Å–∏

- –î–ª—è **–∫–ª–∞—Å—Å–æ–≤ (`@ManyToOne`, `@OneToOne`)** Hibernate –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **CGLIB/Javassist –ø—Ä–æ–∫—Å–∏**:
    
    - —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–¥–∫–ª–∞—Å—Å —Å—É—â–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Order_$HibernateProxy`).
        
    - —ç—Ç–æ—Ç –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–µ—Ç—Ç–µ—Ä—ã –∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã.
        
    - –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–∫—Å–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ `Session` + `EntityEntry` (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ —Å—É—â–Ω–æ—Å—Ç–∏).
        
- –î–ª—è **–∫–æ–ª–ª–µ–∫—Ü–∏–π (`@OneToMany`, `@ManyToMany`)** Hibernate –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏-–ø—Ä–æ–∫—Å–∏:
    
    - `PersistentBag`, `PersistentSet`, `PersistentList`.
        
    - –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º –æ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç: "–∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ?"
        
        - –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è SQL-–∑–∞–ø—Ä–æ—Å.
            
        - –µ—Å–ª–∏ –¥–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
            

–ü—Ä–∏–º–µ—Ä: –≤–º–µ—Å—Ç–æ `List<Order>` —Ä–µ–∞–ª—å–Ω–æ –ª–µ–∂–∏—Ç –æ–±—ä–µ–∫—Ç `org.hibernate.collection.internal.PersistentBag`.

---

## üîÑ 3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª LAZY-–æ–±—ä–µ–∫—Ç–∞

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º:

`User user = session.get(User.class, 1L); List<Order> orders = user.getOrders(); // LAZY! orders.size(); // <-- –∑–¥–µ—Å—å –∑–∞–ø—Ä–æ—Å!`

- `user.getOrders()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–ø—Ä–æ–∫—Å–∏-–∫–æ–ª–ª–µ–∫—Ü–∏—é** `PersistentBag`.
    
- –ø–æ–∫–∞ –º—ã **–Ω–µ –æ–±—Ä–∞—â–∞–µ–º—Å—è** –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º ‚Äî SQL –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.
    
- –ø—Ä–∏ `orders.size()` Hibernate –≤—ã–∑—ã–≤–∞–µ—Ç:
    
    1. –ø—Ä–æ–≤–µ—Ä–∫—É: "–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è?"
        
    2. –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–¥—ë—Ç –≤ `PersistenceContext` (1st-level cache).
        
    3. –µ—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è SQL `SELECT * FROM orders WHERE user_id=?`.
        

---

## üí• 4. –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è LazyInitializationException?

–û—à–∏–±–∫–∞:

`org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: User.orders, could not initialize proxy - no Session`

–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–∞–∫:

1. `Session` —É–∂–µ **–∑–∞–∫—Ä—ã—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º—ã –≤–µ—Ä–Ω—É–ª–∏ `User` –≤ —Å–ª–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞).
    
2. –º—ã –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –ª–µ–Ω–∏–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (`user.getOrders().size()`).
    
3. –ø—Ä–æ–∫—Å–∏ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–π—Ç–∏ –≤ `Session`, –Ω–æ `Session = null`.
    
4. Hibernate –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí –∫–∏–¥–∞–µ—Ç **LazyInitializationException**.
    

---

## üì¶ 5. –†–µ—à–µ–Ω–∏—è (–∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å)

- **Open Session in View (OSIV)** ‚Äî –¥–µ—Ä–∂–∏–º `Session` –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ –∫–æ–Ω—Ü–∞ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å N+1).
    
- **JOIN FETCH**:
    
    `SELECT u FROM User u JOIN FETCH u.orders WHERE u.id = :id`
    
    –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É.
    
- **DTO –º–∞–ø–ø–∏–Ω–≥** ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω—ã.
    
- **Hibernate.initialize(entity.getOrders())** ‚Äî —è–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏.
    
- **EntityGraph / @NamedEntityGraph** ‚Äî –≥–∏–±–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
    

---

## üß† 6. –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º LazyInitializationException

- –ø—Ä–æ–∫—Å–∏ (`PersistentBag`) —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ `SessionImplementor`.
    
- –µ—Å–ª–∏ `session.isOpen() == false` ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `LazyInitializationException`.
    
- –≤–Ω—É—Ç—Ä–∏ `AbstractPersistentCollection#initialize()` –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞:
    
    `if (session == null) {     throw new LazyInitializationException("could not initialize proxy - no Session"); }`
    

---

‚úÖ –ò—Ç–æ–≥–æ:

- **LAZY –∑–∞–≥—Ä—É–∑–∫–∞ = –ø—Ä–æ–∫—Å–∏-–æ–±—ä–µ–∫—Ç—ã (CGLIB/Javassist) + –∫–æ–ª–ª–µ–∫—Ü–∏–∏-–ø—Ä–æ–∫—Å–∏ (PersistentBag, PersistentSet).**
    
- **–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏.**
    
- **LazyInitializationException = –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è Session.**

–∫–∞–∫ **Hibernate —Å—Ç—Ä–æ–∏—Ç SQL-–∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LAZY-–∫–æ–ª–ª–µ–∫—Ü–∏–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@OneToMany` –∏–ª–∏ `@ManyToMany`).

---

## üîπ –°—Ü–µ–Ω–∞—Ä–∏–π

–£ –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–∫–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏:

`@Entity class User {     @Id     private Long id;      @OneToMany(mappedBy = "user", fetch = FetchType.LAZY)     private List<Order> orders; }  @Entity class Order {     @Id     private Long id;      @ManyToOne     private User user; }`

---

## üîπ –ö–∞–∫ Hibernate —É–∑–Ω–∞—ë—Ç, –∫–∞–∫–æ–π SQL –ø–æ—Å—Ç—Ä–æ–∏—Ç—å?

1. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**  
    –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Hibernate –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ (`@OneToMany`, `@ManyToOne`, `mappedBy`, `JoinColumn` –∏ —Ç.–¥.).  
    –û–Ω —Å—Ç—Ä–æ–∏—Ç **–º–µ—Ç–∞–º–æ–¥–µ–ª—å**: –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –∫–∞–∫–∏–µ —Å–≤—è–∑–∏, –∫–∞–∫–∏–µ –∫–ª—é—á–∏ (FK).  
    üëâ –í –ø—Ä–∏–º–µ—Ä–µ:
    
    - `User` ‚Üî `Order` —Å–≤—è–∑–∞–Ω—ã –ø–æ `Order.user_id`.
        
    - `orders` —É `User` ‚Äî —ç—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –º–∞–ø–ø–∏—Ç—å—Å—è –∫ `SELECT ... WHERE user_id = ?`.
        

---

2. **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏-–∫–æ–ª–ª–µ–∫—Ü–∏–∏ (PersistentBag, PersistentSet, –∏ —Ç.–¥.)**  
    –ö–æ–≥–¥–∞ –º—ã –∑–∞–≥—Ä—É–∂–∞–µ–º `User`, Hibernate –Ω–µ —Ç—è–Ω–µ—Ç `orders`.  
    –í–º–µ—Å—Ç–æ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ `List<Order>` –æ–Ω –ø–æ–¥—Å–æ–≤—ã–≤–∞–µ—Ç **–æ–±—ë—Ä—Ç–∫—É** `PersistentBag`, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç:
    
    - —Å—Å—ã–ª–∫—É –Ω–∞ `Session` (–¥–ª—è —Å–≤—è–∑–∏ —Å –ë–î),
        
    - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–ø–ø–∏–Ω–≥–µ (`user_id` –∫–∞–∫ FK),
        
    - —Ñ–ª–∞–≥ "–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ / –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ".
        

---

3. **–ü–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏**  
    –ö–æ–≥–¥–∞ –º—ã –¥–µ–ª–∞–µ–º:
    
    `user.getOrders().size();`
    
    Hibernate –≤–∏–¥–∏—Ç, —á—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è **–Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞**, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç **`CollectionInitializer`**.
    

---

4. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞**  
    Hibernate –±–µ—Ä—ë—Ç:
    
    - –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (`orders`),
        
    - —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Å–≤—è–∑–∏ (`user_id`),
        
    - –∑–Ω–∞—á–µ–Ω–∏–µ `user.getId()`.
        
    
    –û–Ω –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–æ –≤ SQL-—à–∞–±–ª–æ–Ω, —Ö—Ä–∞–Ω—è—â–∏–π—Å—è –≤ –º–µ—Ç–∞–º–æ–¥–µ–ª–∏.
    
    –ò—Ç–æ–≥–æ–≤—ã–π SQL:
    
    `select o.id, o.user_id, o.other_columns from orders o where o.user_id = ?`
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä `?` = `user.id`.
    

---

5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ batch-fetching**  
    –ï—Å–ª–∏ –≤–∫–ª—é—á–∏—Ç—å `hibernate.default_batch_fetch_size = 16`, Hibernate –º–æ–∂–µ—Ç –≤–º–µ—Å—Ç–æ 16 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–¥–µ–ª–∞—Ç—å:
    
    `select o.id, o.user_id, o.other_columns from orders o where o.user_id in (?, ?, ?, ...)`
    
    –≠—Ç–æ **batch loading**, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `N+1`.
    

---

6. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏**  
    Hibernate —Å–æ–∑–¥–∞—ë—Ç `Order` –æ–±—ä–µ–∫—Ç—ã (—á–µ—Ä–µ–∑ `EntityPersister`) –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ `PersistentBag`.  
    –¢–µ–ø–µ—Ä—å –∫–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è**.
    

---

## üîπ –ü–æ—á–µ–º—É WHERE –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π?

Hibernate –±–µ—Ä—ë—Ç **–∫–ª—é—á —Å–≤—è–∑–∏ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**.

- –ï—Å–ª–∏ `@OneToMany(mappedBy = "user")` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FK –≤ `Order`.
    
- –ï—Å–ª–∏ `@ManyToMany` ‚Üí –±–µ—Ä—ë—Ç—Å—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (`user_orders`).
    
- –ï—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π `@JoinColumn(name = "custom_id")` ‚Üí –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –æ–Ω.
    

üëâ –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `EntityPersister` –∏ `CollectionPersister`.

---

## üîπ –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç

Hibernate –Ω–µ "–ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç" –∑–∞–ø—Ä–æ—Å –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ.  
–û–Ω **–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL-—à–∞–±–ª–æ–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ** (–ø–æ –º–µ—Ç–∞–º–æ–¥–µ–ª–∏) –∏ –ø–æ—Ç–æ–º –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è (`user.id`).

## üîπ 1. –ü–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ (Session cache)

- –≠—Ç–æ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π** –∫—ç—à, –≤–∫–ª—é—á—ë–Ω –≤—Å–µ–≥–¥–∞.
    
- –ñ–∏–≤—ë—Ç **—Å—Ç—Ä–æ–≥–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö `Session`** (Hibernate session = `EntityManager` –≤ JPA).
    
- –û–Ω —Ö—Ä–∞–Ω–∏—Ç **identity map**: —Å—É—â–Ω–æ—Å—Ç—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –µ—ë `@Id`.
    

### –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º:

- –ö–æ–≥–¥–∞ —Ç—ã –¥–µ–ª–∞–µ—à—å `session.get(User.class, 1L)`, Hibernate:
    
    1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç **–∫—ç—à 1-–≥–æ —É—Ä–æ–≤–Ω—è**: –µ—Å—Ç—å –ª–∏ –≤ –Ω—ë–º –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º `(User, id=1)`.
        
    2. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ **–±–µ–∑ SQL**.
        
    3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç `SELECT ... FROM users WHERE id=1`, –∫–ª–∞–¥—ë—Ç –≤ –∫—ç—à –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç.
        
- –î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –≤—ã–∑–æ–≤–µ—à—å `session.get(User.class, 1L)` 100 —Ä–∞–∑ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî SQL –±—É–¥–µ—Ç **—Ä–æ–≤–Ω–æ 1 —Ä–∞–∑**.
    

‚ö° –ü–ª—é—Å: —ç–∫–æ–Ω–æ–º–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.  
‚ö° –ú–∏–Ω—É—Å: –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –∂–∏–≤ `Session`.

---

## üîπ 2. –í—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ (SessionFactory-level)

- –≠—Ç–æ **–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—ç—à**, –Ω–∞–¥–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Ä—É–∫–∞–º–∏ (`Ehcache`, `Hazelcast`, `Infinispan`, `Caffeine` –∏ —Ç.–¥.).
    
- –ñ–∏–≤—ë—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ **SessionFactory** (—Ç.–µ. –æ–±—â–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π).
    
- –ö—ç—à–∏—Ä—É–µ—Ç **—Å—É—â–Ω–æ—Å—Ç–∏**, **–∫–æ–ª–ª–µ–∫—Ü–∏–∏**, –∏ –∏–Ω–æ–≥–¥–∞ **—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤**.
    

### –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º:

1. –¢—ã –¥–µ–ª–∞–µ—à—å `session.get(User.class, 1L)` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Ññ1.
    
    - Hibernate –¥–æ—Å—Ç–∞—ë—Ç –∑–∞–ø–∏—Å—å –∏–∑ –ë–î –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤:
        
        - 1-–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ (–¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏),
            
        - 2-–π —É—Ä–æ–≤–µ–Ω—å (–¥–ª—è –≤—Å–µ—Ö).
            
2. –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Ññ2 (–¥—Ä—É–≥–æ–π `Session`) Hibernate –¥–µ–ª–∞–µ—Ç —Ç–æ—Ç –∂–µ –≤—ã–∑–æ–≤:
    
    - –°–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏—Ç –≤ **2-–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞**.
        
    - –ï—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç —Å `id=1` ‚Üí **SQL –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è** –≤–æ–æ–±—â–µ.
        
    - –û–±—ä–µ–∫—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É.
        

---

## üîπ 3. –ö—ç—à –∫–æ–ª–ª–µ–∫—Ü–∏–π (lazy)

- –ï—Å–ª–∏ —É `User` –µ—Å—Ç—å `@OneToMany List<Order> orders` —Å `FetchType.LAZY`, Hibernate:
    
    - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ `orders` —Å—Ç—Ä–æ–∏—Ç **SELECT orders ... WHERE user_id=?**.
        
    - –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω **2-–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π**, Hibernate —Å–æ—Ö—Ä–∞–Ω–∏—Ç **–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–∫–∞–∑–æ–≤** (`order_id`) –≤ –∫—ç—à–µ.
        
    - –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ `orders` Hibernate:
        
        - –ë–µ—Ä—ë—Ç —Å–ø–∏—Å–æ–∫ id-—à–Ω–∏–∫–æ–≤ –∏–∑ –∫—ç—à–∞,
            
        - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—â–µ—Ç —Å—É—â–Ω–æ—Å—Ç—å –≤ –∫—ç—à–µ —Å—É—â–Ω–æ—Å—Ç–µ–π,
            
        - –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç ‚Üí –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∏–∑ –ë–î.
            

---

## üîπ 4. –ö—ç—à –∑–∞–ø—Ä–æ—Å–æ–≤ (Query cache)

- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –∫—ç—à–∏—Ä—É–µ—Ç **–Ω–µ —Å—É—â–Ω–æ—Å—Ç–∏, –∞ —Å–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞**.
    
- –ù–∞–ø—Ä–∏–º–µ—Ä:
    
    `Query q = session.createQuery("from User where age > 18"); q.setCacheable(true);`
    
- –ü–µ—Ä–≤—ã–π —Ä–∞–∑ Hibernate –≤—ã–ø–æ–ª–Ω–∏—Ç SQL, —Å–æ—Ö—Ä–∞–Ω–∏—Ç **—Å–ø–∏—Å–æ–∫ id-—à–Ω–∏–∫–æ–≤**.
    
- –í—Ç–æ—Ä–æ–π —Ä–∞–∑ ‚Äî –¥–æ—Å—Ç–∞–Ω–µ—Ç id-—à–Ω–∏–∫–∏ –∏–∑ –∫—ç—à–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ 1-–≥–æ/2-–≥–æ —É—Ä–æ–≤–Ω—è.
    

---

## üîπ –ü–æ—á–µ–º—É –∏–Ω–æ–≥–¥–∞ SQL **–Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–æ–æ–±—â–µ**

1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ:
    
    - –î–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–ª–∏ –≤ 1-–π –∏–ª–∏ 2-–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞.
        
2. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º:
    
    - Hibernate –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—ç—à,
        
    - –ù–∞—Ö–æ–¥–∏—Ç —Ç–∞–º —Å—É—â–Ω–æ—Å—Ç—å/–∫–æ–ª–ª–µ–∫—Ü–∏—é,
        
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –±–µ–∑ SQL.
        

üí° –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:

- –í –ø—Ä–µ–¥–µ–ª–∞—Ö **–æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** —Ä–∞–±–æ—Ç–∞–µ—Ç 1-–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ ‚Üí SQL –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è.
    
- –ú–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏/—Å–µ—Å—Å–∏—è–º–∏ –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å 2-–π —É—Ä–æ–≤–µ–Ω—å.
    
- –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω –µ—â—ë –∏ query cache ‚Üí –¥–∞–∂–µ —Å–ª–æ–∂–Ω—ã–µ HQL –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –±–µ–∑ SQL.
    

---

üî• –ò—Ç–æ–≥:  
Hibernate —Å—Ç—Ä–æ–∏—Ç –ø–∏—Ä–∞–º–∏–¥—É –∫—ç—à–µ–π:

- **Session (1-–π —É—Ä–æ–≤–µ–Ω—å)** ‚Üí –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.
    
- **SessionFactory (2-–π —É—Ä–æ–≤–µ–Ω—å)** ‚Üí –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å.
    
- **Query cache** ‚Üí –æ—Ç–¥–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ—Ç—Å—è.
    

üëâ –ò –∏–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É —Ç—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å `findById(1)` —Ö–æ—Ç—å 100 —Ä–∞–∑ –∏ SQL –Ω–µ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è ‚Äî Hibernate —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —Å–≤–æ–∏ –∫—ç—à–∏.